{{define "header"}}
<header class="terminal-box rounded-md p-4 lg:p-6 mb-8 relative">
    <div class="flex items-center justify-between gap-2 lg:gap-4">
        <!-- Logo -->
        {{template "app-name"}}
        
        <!-- Desktop Navigation & Mobile Menu Button -->
        <div class="flex items-center space-x-2 lg:space-x-4 flex-shrink-0">
            <!-- Desktop Navigation -->
            <nav id="desktop-nav" class="flex items-center space-x-4 max-lg:hidden">
                <a href="/"
                   hx-get="/"
                   hx-push-url="/"
                   hx-target="#main-content"
                   hx-swap="innerHTML"
                   class="cyber-button px-4 py-2 rounded text-sm font-mono uppercase tracking-wide flex items-center">
                    <span class="text-red-400 mr-2">‚óè</span>
                    LIVE_FEED
                </a>
                <a href="/archive"
                   hx-get="/archive"
                   hx-push-url="/archive"
                   hx-target="#main-content"
                   hx-swap="innerHTML"
                   class="cyber-button px-4 py-2 rounded text-sm font-mono uppercase tracking-wide flex items-center">
                    <span class="text-blue-400 mr-2">‚ñ£</span>
                    DATA_VAULT
                </a>
            </nav>
            
            <!-- Login Button (Desktop Only) -->
            <button id="login-btn" class="cyber-button px-4 py-2 rounded text-sm font-mono uppercase tracking-wide flex items-center max-lg:hidden">
                <span class="text-cyan-400 mr-2">üîë</span>
                LOGIN
            </button>
            
            <!-- Mobile Menu Button -->
            <button id="mobile-menu-button" class="lg:hidden p-2 cyber-button text-sm">
                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                </svg>
            </button>
        </div>
    </div>
    
    
    <!-- Terminal prompt line -->
    <div class="mt-4 text-xs opacity-60 font-mono">
        <span class="text-green-400">root@stream-node:~$</span> <span class="text-cyan-400">./initialize_stream_interface.sh</span>
        <span class="animate-pulse">‚ñà</span>
    </div>
</header>

<script>

    // Initialize mobile navigation - prevent duplicate setup
    if (!window.mobileNavInitialized) {
        window.mobileNavInitialized = true;

        function createMobileLoginButton() {
            return `
                <button id="mobile-login-btn" style="
                    display: flex;
                    align-items: center;
                    padding: 12px;
                    color: #00ff41;
                    background: transparent;
                    border: 1px solid #00ff41;
                    border-radius: 4px;
                    font-size: 14px;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                    transition: all 0.3s ease;
                    width: 100%;
                    cursor: pointer;
                    font-family: inherit;
                " onmouseover="this.style.background='#00ff41'; this.style.color='black';"
                   onmouseout="this.style.background='transparent'; this.style.color='#00ff41';">
                    <span style="color: #44ffff; margin-right: 8px;">üîë</span>
                    LOGIN
                </button>
            `;
        }

        function createMobileProfileSection() {
            const session = window.gnostreamAuth ? window.gnostreamAuth.getSession() : null;
            const userProfile = window.userProfile; // Access global userProfile

            if (!session) return createMobileLoginButton();

            const displayName = userProfile && (userProfile.display_name || userProfile.name) || 'USER';
            const profilePicture = userProfile && userProfile.picture;

            return `
                <div style="border: 1px solid #00ff41; border-radius: 4px; margin-bottom: 8px; overflow: hidden;">
                    <div style="display: flex; align-items: center; padding: 12px; background: rgba(0, 255, 65, 0.1);">
                        ${profilePicture ?
                            `<img src="${profilePicture}" alt="Profile" style="width: 32px; height: 32px; border-radius: 50%; margin-right: 12px; object-fit: cover;">` :
                            `<div style="width: 32px; height: 32px; border-radius: 50%; background: #666; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <span style="color: #999;">üë§</span>
                             </div>`
                        }
                        <div style="flex: 1;">
                            <div style="color: #00ff41; font-weight: 500; font-size: 14px;">${displayName}</div>
                        </div>
                    </div>
                    <button onclick="handleMobileSettings()" style="
                        display: flex;
                        align-items: center;
                        padding: 12px;
                        color: #00ff41;
                        background: transparent;
                        border: none;
                        border-top: 1px solid #00ff41;
                        font-size: 12px;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                        width: 100%;
                        cursor: pointer;
                        font-family: inherit;
                    " onmouseover="this.style.background='rgba(0, 255, 65, 0.1)';"
                       onmouseout="this.style.background='transparent';">
                        <span style="margin-right: 8px;">‚öôÔ∏è</span>
                        SETTINGS
                    </button>
                    <button onclick="handleMobileLogout()" style="
                        display: flex;
                        align-items: center;
                        padding: 12px;
                        color: #ff4444;
                        background: transparent;
                        border: none;
                        border-top: 1px solid #00ff41;
                        font-size: 12px;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                        width: 100%;
                        cursor: pointer;
                        font-family: inherit;
                    " onmouseover="this.style.background='rgba(255, 68, 68, 0.1)';"
                       onmouseout="this.style.background='transparent';">
                        <span style="margin-right: 8px;">üö™</span>
                        LOGOUT
                    </button>
                </div>
            `;
        }

        function handleMobileSettings() {
            // Close mobile dropdown
            const dropdown = document.getElementById('mobile-dropdown');
            if (dropdown) dropdown.remove();

            // Call the same settings function
            if (window.showSettings) {
                window.showSettings();
            } else {
                console.log('üîß Settings clicked - will implement settings page next');
                alert('Settings page coming soon!');
            }
        }

        function handleMobileLogout() {
            // Close mobile dropdown
            const dropdown = document.getElementById('mobile-dropdown');
            if (dropdown) dropdown.remove();

            // Call the auth logout function
            if (window.gnostreamAuth && window.gnostreamAuth.logout) {
                window.gnostreamAuth.logout();
            } else if (window.logout) {
                window.logout();
            }
        }

        function initMobileNav() {
            console.log('Initializing mobile navigation...');
            const mobileButton = document.getElementById('mobile-menu-button');
            
            console.log('Found elements:', {
                button: !!mobileButton,
                buttonElement: mobileButton
            });
            
            if (mobileButton && !mobileButton.hasAttribute('data-nav-initialized')) {
                console.log('Setting up mobile nav click handler');
                
                // Mark button as initialized to prevent duplicate listeners
                mobileButton.setAttribute('data-nav-initialized', 'true');
                
                // Remove any existing listeners
                mobileButton.onclick = null;
                
                mobileButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Mobile menu button clicked');
                    
                    // Check if dropdown already exists
                    let dropdown = document.getElementById('mobile-dropdown');
                    
                    if (dropdown) {
                        // Remove existing dropdown
                        dropdown.remove();
                        console.log('Dropdown closed');
                        return;
                    }
                    
                    // Create dropdown element
                    dropdown = document.createElement('div');
                    dropdown.id = 'mobile-dropdown';
                    
                    // Get button position for positioning
                    const buttonRect = mobileButton.getBoundingClientRect();
                    
                    // Style the dropdown
                    dropdown.style.cssText = `
                        position: fixed;
                        top: ${buttonRect.bottom + 5}px;
                        right: 16px;
                        background: #001100;
                        border: 2px solid #00ff41;
                        border-radius: 8px;
                        padding: 16px;
                        min-width: 220px;
                        z-index: 1000;
                        box-shadow: 0 4px 20px rgba(0, 255, 65, 0.3);
                        font-family: 'Share Tech Mono', monospace;
                        max-width: calc(100vw - 32px);
                    `;
                    
                    // Check if user is authenticated
                    const isAuthenticated = window.gnostreamAuth && window.gnostreamAuth.isAuthenticated();

                    // Add navigation links and auth section
                    dropdown.innerHTML = `
                        <a href="/" style="
                            display: flex;
                            align-items: center;
                            padding: 12px;
                            color: #00ff41;
                            text-decoration: none;
                            border: 1px solid #00ff41;
                            border-radius: 4px;
                            margin-bottom: 8px;
                            font-size: 14px;
                            text-transform: uppercase;
                            letter-spacing: 1px;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='#00ff41'; this.style.color='black';"
                           onmouseout="this.style.background='transparent'; this.style.color='#00ff41';">
                            <span style="color: #ff4444; margin-right: 8px;">‚óè</span>
                            LIVE_FEED
                        </a>
                        <a href="/archive" style="
                            display: flex;
                            align-items: center;
                            padding: 12px;
                            color: #00ff41;
                            text-decoration: none;
                            border: 1px solid #00ff41;
                            border-radius: 4px;
                            margin-bottom: 8px;
                            font-size: 14px;
                            text-transform: uppercase;
                            letter-spacing: 1px;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='#00ff41'; this.style.color='black';"
                           onmouseout="this.style.background='transparent'; this.style.color='#00ff41';">
                            <span style="color: #44aaff; margin-right: 8px;">‚ñ£</span>
                            DATA_VAULT
                        </a>
                        ${isAuthenticated ? createMobileProfileSection() : createMobileLoginButton()}
                    `;
                    
                    // Add click handlers for navigation
                    const links = dropdown.querySelectorAll('a');
                    links.forEach(link => {
                        link.addEventListener('click', function() {
                            dropdown.remove();
                            console.log('Navigating via dropdown');
                        });
                    });
                    
                    // Add click handler for mobile login button (if present)
                    const mobileLoginBtn = dropdown.querySelector('#mobile-login-btn');
                    if (mobileLoginBtn) {
                        mobileLoginBtn.addEventListener('click', function() {
                            dropdown.remove();
                            // Trigger the login modal
                            if (window.gnostreamAuth && window.gnostreamAuth.showModal) {
                                window.gnostreamAuth.showModal();
                            } else {
                                // Fallback if auth system not loaded yet
                                const loginBtn = document.getElementById('login-btn');
                                if (loginBtn) {
                                    loginBtn.click();
                                }
                            }
                        });
                    }
                    
                    // Add to page
                    document.body.appendChild(dropdown);
                    console.log('Dropdown opened');
                    
                    // Close dropdown when clicking elsewhere
                    setTimeout(() => {
                        const closeDropdown = (event) => {
                            if (!dropdown.contains(event.target) && !mobileButton.contains(event.target)) {
                                dropdown.remove();
                                document.removeEventListener('click', closeDropdown);
                                console.log('Dropdown closed by outside click');
                            }
                        };
                        document.addEventListener('click', closeDropdown);
                    }, 100);
                });
            } else if (mobileButton && mobileButton.hasAttribute('data-nav-initialized')) {
                console.log('Mobile button already initialized, skipping');
                
                console.log('Mobile navigation setup complete');
            } else {
                console.error('Mobile button not found!', {
                    button: mobileButton
                });
            }
        }
        
        // Try to initialize immediately and on DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initMobileNav);
        } else {
            initMobileNav();
        }
        
        // Also try after a short delay for HTMX navigation
        setTimeout(initMobileNav, 100);
    }
</script>

<style>
.cyber-button {
    background: transparent;
    border: 1px solid #00ff41;
    color: #00ff41;
    transition: all 0.3s ease;
    text-transform: uppercase;
}

.cyber-button:hover:not(:disabled) {
    background-color: #00ff41;
    color: black;
    box-shadow: 0 0 15px rgba(0, 255, 65, 0.5);
}
</style>
{{end}}